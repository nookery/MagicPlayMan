---
description: 重述需求、评估风险，并创建分步实施计划。在修改任何代码之前必须等待用户确认。
---

# Plan 命令

此命令调用 **planner** 代理，在编写任何代码之前创建全面的实施计划。

## 命令功能

1. **重述需求** - 明确需要构建的内容
2. **识别风险** - 揭示潜在问题和阻碍因素
3. **创建分步计划** - 将实施分解为多个阶段
4. **等待确认** - 在继续之前必须获得用户批准

## 使用场景

在以下情况下使用 `/plan`：
- 开始新功能开发
- 进行重大架构变更
- 进行复杂的重构
- 多个文件/组件会受到影响
- 需求不明确或模糊

## 工作原理

planner 代理将：

1. **分析请求** 并用清晰的术语重述需求
2. **分解为阶段** 包含具体、可操作的步骤
3. **识别依赖关系** 组件之间
4. **评估风险** 和潜在阻碍因素
5. **估算复杂度** （高/中/低）
6. **展示计划** 并等待您的明确确认

## 使用示例

```
用户: /plan 添加 PDF 文件缩略图支持

代理 (planner):
# 实施计划：PDF 文件缩略图支持

## 需求重述
为 MagicKit 添加 PDF 文件的缩略图生成功能，支持：
- 从 PDF 第一页生成缩略图
- 与现有缩略图系统集成
- 支持缓存机制
- 错误处理（加密 PDF、损坏文件等）

## 实施阶段

### 阶段 1：创建 PDF 缩略图生成器
- 在 `Thumbnail/` 创建 `Thumbnail+PDF.swift`
- 实现 `pdfThumbnail(size:verbose:)` 方法
- 使用 PDFKit 生成第一页的缩略图
- 返回 `ThumbnailResult`

### 阶段 2：集成到 ThumbnailGenerator
- 在 `ThumbnailGenerator.generate()` 中添加 PDF 分支
- 调用 `pdfThumbnail()` 方法
- 处理错误情况

### 阶段 3：扩展 URL 类型检测
- 在 URL 扩展中添加 `isPDF` 计算属性
- 更新 `fileType` 逻辑以识别 PDF

### 阶段 4：更新单元测试
- 添加 PDF 缩略图测试用例
- 测试加密 PDF 的错误处理
- 验证缓存功能

### 阶段 5：更新预览和示例
- 在 `ExtUrl+Samples.swift` 添加 PDF 示例
- 创建预览展示 PDF 缩略图

## 依赖项
- PDFKit（系统框架，macOS/iOS 可用）
- 现有缩略图缓存系统

## 风险
- 中：PDF 文件可能很大，生成缩略图耗时
- 中：加密 PDF 无法生成缩略图，需要优雅降级
- 低：PDFKit 在不同平台的行为差异

## 预估复杂度：中等
- PDF 缩略图生成器：1-2 小时
- 集成工作：30 分钟
- 测试：1 小时
- 总计：2.5-3.5 小时

**等待确认**：是否继续此计划？（是/否/修改）
```

## 重要说明

**关键**：planner 代理在您明确使用"是"、"继续"或类似肯定回复确认计划之前，**不会**编写任何代码。

如果您想要修改，请回复：
- "修改：[您的修改内容]"
- "不同方法：[替代方案]"
- "跳过阶段 2，先做阶段 3"

## 规划原则

### 1. 模块化设计

- 公共 API 放在 `URL/` 扩展中
- 实现细节放在专门模块目录（如 `Thumbnail/`）
- 每个功能独立文件（`Thumbnail+PDF.swift`）

### 2. 遵循现有模式

- 参考 `Thumbnail+Audio.swift`、`Thumbnail+Video.swift` 等现有实现
- 保持一致的代码风格和结构
- 使用相同的错误处理模式

### 3. 性能考虑

- 使用缓存避免重复计算
- 后台线程处理耗时操作
- 适当的延迟加载

### 4. 错误处理

- 定义清晰的错误类型
- 优雅降级（返回系统图标）
- 详细日志记录（SuperLog）

## 与其他命令的集成

规划完成后：
- 使用 `/swift-check` 检查代码规范
- 如果出现构建错误，使用 `/build-fix`
- 使用 `/code-review` 审查完成的实施
- 使用 `/commit` 生成提交信息

## 常见功能规划模板

### 添加新的文件类型支持

```
1. 创建 Thumbnail+FileType.swift
2. 实现生成逻辑
3. 集成到 ThumbnailGenerator
4. 添加 URL 类型检测
5. 测试和预览
```

### 添加新的 SwiftUI 组件

```
1. 设计组件接口
2. 创建 State 管理
3. 实现主体 View
4. 添加扩展和 Modifier
5. 预览和测试
```

### 重构现有代码

```
1. 分析当前代码
2. 识别改进点
3. 分步骤重构
4. 保持向后兼容
5. 更新测试
```

## 相关代理

此命令调用位于以下位置的 `planner` 代理：
`.claude/agents/planner.md`
